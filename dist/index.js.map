{"version":3,"sources":["../src/supabase/client.ts","../src/rpc/index.ts","../src/queries/public.ts"],"names":["createClient"],"mappings":"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","file":"index.js","sourcesContent":["import { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from '../types/database';\n\n/**\n * Valida la configurazione Supabase e ritorna URL e anonKey garantiti non undefined.\n * Lancia errori chiari se mancano.\n */\nexport function assertSupabaseConfig(\n  url: string | undefined,\n  anonKey: string | undefined\n): { url: string; anonKey: string } {\n  if (!url) {\n    throw new Error('Supabase URL is required. Please provide a valid URL.');\n  }\n  if (!anonKey) {\n    throw new Error('Supabase anon key is required. Please provide a valid anon key.');\n  }\n  return { url, anonKey };\n}\n\n/**\n * Configurazione per il client browser Supabase\n */\nexport type SupabaseBrowserClientConfig = {\n  url: string;\n  anonKey: string;\n  storageKey?: string;\n  enableTimeoutMs?: number;\n  detectSessionInUrl?: boolean;\n};\n\n/**\n * Crea un fetch wrapper con timeout usando AbortController\n */\nfunction createFetchWithTimeout(timeoutMs: number): typeof fetch {\n  return async (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);\n\n    try {\n      const response = await fetch(input, {\n        ...init,\n        signal: controller.signal,\n      });\n      clearTimeout(timeoutId);\n      return response;\n    } catch (error) {\n      clearTimeout(timeoutId);\n      if (error instanceof Error && error.name === 'AbortError') {\n        throw new Error(`Request timeout after ${timeoutMs}ms`);\n      }\n      throw error;\n    }\n  };\n}\n\n/**\n * Crea un Supabase client per browser (React web apps).\n * \n * Configurazioni predefinite:\n * - persistSession: true\n * - autoRefreshToken: true\n * - detectSessionInUrl: true (configurabile, utile per web reset/login)\n * - storage: window.localStorage se disponibile\n * - fetch timeout: 30000ms se enableTimeoutMs non specificato\n */\nexport function createSupabaseBrowserClient(\n  config: SupabaseBrowserClientConfig\n): SupabaseClient<Database> {\n  const { url, anonKey } = assertSupabaseConfig(config.url, config.anonKey);\n  \n  const storageKey = config.storageKey ?? 'sb-auth-token';\n  const detectSessionInUrl = config.detectSessionInUrl ?? true;\n  const enableTimeoutMs = config.enableTimeoutMs ?? 30000;\n\n  // Determina storage: usa window.localStorage se disponibile, altrimenti undefined\n  const storage = typeof window !== 'undefined' && window.localStorage ? window.localStorage : undefined;\n\n  // Configura fetch con timeout se necessario\n  const customFetch = enableTimeoutMs > 0 \n    ? createFetchWithTimeout(enableTimeoutMs)\n    : undefined;\n\n  return createClient<Database>(url, anonKey, {\n    auth: {\n      persistSession: true,\n      autoRefreshToken: true,\n      detectSessionInUrl,\n      storage,\n      storageKey,\n    },\n    global: {\n      fetch: customFetch,\n    },\n  });\n}\n\n/**\n * Configurazione per il client Expo Supabase\n */\nexport type SupabaseExpoClientConfig = {\n  url: string;\n  anonKey: string;\n  storage?: {\n    getItem: (key: string) => Promise<string | null> | string | null;\n    setItem: (key: string, value: string) => Promise<void> | void;\n    removeItem: (key: string) => Promise<void> | void;\n  };\n  storageKey?: string;\n};\n\n/**\n * Crea un Supabase client per Expo/React Native.\n * \n * Configurazioni predefinite:\n * - persistSession: true\n * - autoRefreshToken: true\n * - detectSessionInUrl: false (non supportato in Expo)\n * - storage: passato dal consumer (es. expo-secure-store, AsyncStorage, ecc.)\n * \n * NOTA: Non assume localStorage. Il consumer deve passare uno storage compatibile.\n * Esempio con expo-secure-store o @react-native-async-storage/async-storage\n */\nexport function createSupabaseExpoClient(\n  config: SupabaseExpoClientConfig\n): SupabaseClient<Database> {\n  const { url, anonKey } = assertSupabaseConfig(config.url, config.anonKey);\n  \n  const storageKey = config.storageKey ?? 'sb-auth-token';\n  const storage = config.storage;\n\n  return createClient<Database>(url, anonKey, {\n    auth: {\n      persistSession: true,\n      autoRefreshToken: true,\n      detectSessionInUrl: false, // Non supportato in Expo\n      storage: storage as any, // Supabase accetta storage custom con questa interfaccia\n      storageKey,\n    },\n  });\n}\n\n","import type { SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from '../types/database';\n\n/**\n * Risultato della chiamata RPC book_lesson\n */\nexport type BookLessonResult = {\n  ok: boolean;\n  reason?: string;\n  booking_id?: string | number;\n};\n\n/**\n * Risultato della chiamata RPC cancel_booking\n */\nexport type CancelBookingResult = {\n  ok: boolean;\n  reason?: string;\n};\n\n/**\n * Parametri per bookLesson\n */\nexport type BookLessonParams = {\n  lessonId: string;\n  subscriptionId?: string;\n};\n\n/**\n * Parametri per cancelBooking\n */\nexport type CancelBookingParams = {\n  bookingId: string;\n};\n\n/**\n * Helper per gestire errori dalle chiamate RPC\n */\nfunction handleRpcError(error: any, rpcName: string): never {\n  if (error?.message) {\n    throw new Error(`RPC ${rpcName} failed: ${error.message}`);\n  }\n  throw new Error(`RPC ${rpcName} failed with unknown error`);\n}\n\n/**\n * Wrapper tipizzato per la RPC book_lesson.\n * Prenota una lezione usando l'ID della lezione e opzionalmente l'ID della subscription.\n * \n * @param client - Il client Supabase autenticato\n * @param params - Parametri per la prenotazione\n * @returns Promise<BookLessonResult> con ok, reason opzionale, e booking_id se successo\n * @throws Error se la chiamata RPC fallisce\n */\nexport async function bookLesson(\n  client: SupabaseClient<Database>,\n  params: BookLessonParams\n): Promise<BookLessonResult> {\n  const { lessonId, subscriptionId } = params;\n\n  const { data, error } = await (client.rpc as any)('book_lesson', {\n    p_lesson_id: lessonId,\n    p_subscription_id: subscriptionId,\n  });\n\n  if (error) {\n    handleRpcError(error, 'book_lesson');\n  }\n\n  // Assumiamo che la RPC ritorni un oggetto con ok, reason?, booking_id?\n  // Se ritorna un array o altro formato, il consumer dovrà adattare i types\n  return data as BookLessonResult;\n}\n\n/**\n * Wrapper tipizzato per la RPC cancel_booking.\n * Cancella una prenotazione usando l'ID della prenotazione.\n * \n * @param client - Il client Supabase autenticato\n * @param params - Parametri per la cancellazione\n * @returns Promise<CancelBookingResult> con ok e reason opzionale\n * @throws Error se la chiamata RPC fallisce\n */\nexport async function cancelBooking(\n  client: SupabaseClient<Database>,\n  params: CancelBookingParams\n): Promise<CancelBookingResult> {\n  const { bookingId } = params;\n\n  const { data, error } = await (client.rpc as any)('cancel_booking', {\n    p_booking_id: bookingId,\n  });\n\n  if (error) {\n    handleRpcError(error, 'cancel_booking');\n  }\n\n  // Assumiamo che la RPC ritorni un oggetto con ok, reason?\n  return data as CancelBookingResult;\n}\n\n","import type { SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from '../types/database';\n\n/**\n * Tipo per i nomi delle views pubbliche del sito.\n * Le views devono iniziare con \"public_site_\" per essere considerate pubbliche.\n */\nexport type PublicViewName = `public_site_${string}`;\n\n/**\n * Helper per accedere alle views pubbliche in modo type-safe.\n * Questo impedisce l'uso accidentale di tabelle non pubbliche.\n * \n * NOTA: Le views pubbliche (public_site_*) devono essere create nel database e i types\n * devono essere rigenerati prima di usare questa funzione.\n * \n * @param client - Il client Supabase (può essere anonimo per views pubbliche)\n * @param view - Il nome della view pubblica (deve iniziare con \"public_site_\")\n * @returns Il query builder per la view specificata\n */\nexport function fromPublic<T extends PublicViewName>(\n  client: SupabaseClient<Database>,\n  view: T\n) {\n  // @ts-expect-error - Le views public_site_* non sono ancora presenti nel database types\n  // Verrà risolto quando le views verranno create e i types rigenerati\n  return client.from(view);\n}\n \n/**\n * Parametri opzionali per filtrare lo schedule pubblico per date\n */\nexport type GetPublicScheduleParams = {\n  from?: string;\n  to?: string;\n};\n\n/**\n * Recupera lo schedule pubblico dal database.\n * Questa funzione accede alla view public_site_schedule e applica filtri opzionali per date.\n * \n * NOTA: La view public_site_schedule deve essere creata nel database e i types devono essere rigenerati\n * prima di usare questa funzione.\n * \n * @param client - Il client Supabase (anonimo ok per views pubbliche)\n * @param params - Parametri opzionali per filtrare per date\n * @returns Promise con i dati dello schedule\n * @throws Error se la query fallisce\n */\nexport async function getPublicSchedule(\n  client: SupabaseClient<Database>,\n  params?: GetPublicScheduleParams\n) {\n  let query = fromPublic(client, 'public_site_schedule').select('*');\n\n  if (params?.from) {\n    query = query.gte('date', params.from);\n  }\n  if (params?.to) {\n    query = query.lte('date', params.to);\n  }\n\n  const { data, error } = await query;\n\n  if (error) {\n    throw new Error(`Failed to fetch public schedule: ${error.message}`);\n  }\n\n  return data;\n}\n\n/**\n * Recupera i prezzi pubblici dal database.\n * Questa funzione accede alla view public_site_pricing.\n * \n * NOTA: La view public_site_pricing deve essere creata nel database e i types devono essere rigenerati\n * prima di usare questa funzione.\n * \n * @param client - Il client Supabase (anonimo ok per views pubbliche)\n * @returns Promise con i dati dei prezzi\n * @throws Error se la query fallisce\n */\nexport async function getPublicPricing(client: SupabaseClient<Database>) {\n  const { data, error } = await fromPublic(client, 'public_site_pricing')\n    .select('*');\n\n  if (error) {\n    throw new Error(`Failed to fetch public pricing: ${error.message}`);\n  }\n\n  return data;\n}\n\n"]}